<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>相機錄影示範</title>
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
</head>
<body>
  <div id="app">
    <el-container>
      <el-main>
        <!-- 預覽使用者相機畫面 -->
        <video ref="previewRef" autoplay playsinline style="width:100%;"></video>
        <!-- 依序顯示每一次錄影結果 -->
        <div v-for="video in videoList" :key="video.index" style="margin-top: 16px;">
          <p>第 {{ video.index }} 球</p>
          <video :src="video.url" controls style="width:100%;"></video>
          <el-button @click="downloadVideo(video)" style="margin-top:8px;">下載影片 {{ video.index }}</el-button>
        </div>
        <div style="margin-top: 16px;">
          <el-button type="primary" @click="startAutoRecord" :disabled="isRecording">開始五次錄影流程</el-button>
        </div>
      </el-main>
    </el-container>
  </div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Element Plus CDN -->
  <script src="https://unpkg.com/element-plus"></script>
  <!-- 引入 ffmpeg.wasm 用於轉檔 -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>

  <script>
    const { createApp, ref, onMounted } = Vue
    const { createFFmpeg, fetchFile } = FFmpeg

    createApp({
      setup() {
        // ---------- 狀態區 ----------
        const isRecording = ref(false)                 // 是否正在錄影
        const streamRef = ref(null)                   // 使用者媒體串流
        const mediaRecorderRef = ref(null)            // MediaRecorder 實例
        const recordedChunks = ref([])                // 暫存錄影片段
        const videoList = ref([])                     // 已錄製影片列表
        const previewRef = ref(null)                  // 預覽畫面元素
        const ffmpeg = createFFmpeg({ log: false })   // ffmpeg 實例
        const ffmpegLoaded = ref(false)               // ffmpeg 是否已載入

        // ---------- API 呼叫區 ----------
        // 初始化相機
        const initCamera = async () => {
          try {
            streamRef.value = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            })
            previewRef.value.srcObject = streamRef.value
          } catch (err) {
            alert('無法存取相機或麥克風：' + err.message)
          }
        }

        // ---------- 方法區 ----------
        // 播放倒數提示音
        const playCountdown = () => {
          return new Promise(resolve => {
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
            audio.play()
            audio.onended = resolve
          })
        }

        // 單次錄影邏輯
        const recordOnce = () => {
          return new Promise(resolve => {
            recordedChunks.value = []
            mediaRecorderRef.value = new MediaRecorder(streamRef.value)
            mediaRecorderRef.value.ondataavailable = e => {
              if (e.data.size > 0) recordedChunks.value.push(e.data)
            }
            mediaRecorderRef.value.onstop = () => {
              const blob = new Blob(recordedChunks.value, { type: 'video/webm' })
              resolve(blob)
            }
            mediaRecorderRef.value.start()
            setTimeout(() => mediaRecorderRef.value.stop(), 15000) // 錄影15秒
          })
        }

        // 轉換為 mp4
        const convertToMp4 = async (webmBlob) => {
          if (!ffmpegLoaded.value) {
            await ffmpeg.load()
            ffmpegLoaded.value = true
          }
          ffmpeg.FS('writeFile', 'input.webm', await fetchFile(webmBlob))
          await ffmpeg.run('-i', 'input.webm', 'output.mp4')
          const data = ffmpeg.FS('readFile', 'output.mp4')
          ffmpeg.FS('unlink', 'input.webm')
          ffmpeg.FS('unlink', 'output.mp4')
          return new Blob([data.buffer], { type: 'video/mp4' })
        }

        // 自動連續錄影五次
        const startAutoRecord = async () => {
          if (!streamRef.value) return
          isRecording.value = true
          videoList.value = []
          for (let i = 0; i < 5; i++) {
            await playCountdown()
            const webmBlob = await recordOnce()
            const mp4Blob = await convertToMp4(webmBlob)
            const url = URL.createObjectURL(mp4Blob)
            videoList.value.push({ index: i + 1, url })
            await new Promise(r => setTimeout(r, 10000)) // 間隔10秒
          }
          isRecording.value = false
        }

        // 下載指定影片
        const downloadVideo = (video) => {
          const a = document.createElement('a')
          a.href = video.url
          a.download = `run_${video.index}.mp4`
          a.click()
        }

        // ---------- 生命週期 ----------
        onMounted(() => {
          initCamera()
        })

        return {
          isRecording,
          videoList,
          previewRef,
          startAutoRecord,
          downloadVideo
        }
      }
    })
    .use(ElementPlus)
    .mount('#app')
  </script>
</body>
</html>
