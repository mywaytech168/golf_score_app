<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>相機錄影示範</title>
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
</head>
<body>
  <div id="app">
    <el-container>
      <el-main>
        <!-- 預覽使用者相機畫面 -->
        <video ref="previewRef" autoplay playsinline style="width:100%;"></video>
        <!-- 依序顯示每一次錄影結果 -->
        <div v-for="video in videoList" :key="video.index" style="margin-top: 16px;">
          <p>第 {{ video.index }} 球</p>
          <video :src="video.url" controls style="width:100%;"></video>
          <el-button @click="downloadVideo(video)" style="margin-top:8px;">下載影片 {{ video.index }}</el-button>
        </div>
        <div style="margin-top: 16px;">
          <el-button type="primary" @click="startAutoRecord" :disabled="isRecording">開始五次錄影流程</el-button>
        </div>
      </el-main>
    </el-container>
  </div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Element Plus CDN -->
  <script src="https://unpkg.com/element-plus"></script>

  <script>
    const { createApp, ref, onMounted } = Vue

    createApp({
      setup() {
        // ---------- 狀態區 ----------
        const isRecording = ref(false)
        const streamRef = ref(null)
        const mediaRecorderRef = ref(null)
        const recordedChunks = ref([])
        const videoList = ref([])
        const previewRef = ref(null)

        // ---------- API ----------
        const initCamera = async () => {
          try {
            streamRef.value = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            })
            previewRef.value.srcObject = streamRef.value
          } catch (err) {
            alert('無法存取相機或麥克風：' + err.message)
          }
        }

        const playCountdown = () => {
          return new Promise(resolve => {
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
            audio.play()
            audio.onended = resolve
          })
        }

        const recordOnce = () => {
          return new Promise(resolve => {
            recordedChunks.value = []
            mediaRecorderRef.value = new MediaRecorder(streamRef.value)
            mediaRecorderRef.value.ondataavailable = e => {
              if (e.data.size > 0) recordedChunks.value.push(e.data)
            }
            mediaRecorderRef.value.onstop = () => {
              const blob = new Blob(recordedChunks.value, { type: 'video/webm' })
              resolve(blob)
            }
            mediaRecorderRef.value.start()
            setTimeout(() => mediaRecorderRef.value.stop(), 15000)
          })
        }

        const startAutoRecord = async () => {
          if (!streamRef.value) return
          isRecording.value = true
          videoList.value = []
          for (let i = 0; i < 5; i++) {
            await playCountdown()
            const blob = await recordOnce()
            const url = URL.createObjectURL(blob)
            videoList.value.push({ index: i + 1, url, blob })
            await new Promise(r => setTimeout(r, 10000))
          }
          isRecording.value = false
        }

        const downloadVideo = (video) => {
          const a = document.createElement('a')
          a.href = video.url
          a.download = `run_${video.index}.webm`
          a.click()
        }

        onMounted(() => {
          initCamera()
        })

        return {
          isRecording,
          videoList,
          previewRef,
          startAutoRecord,
          downloadVideo
        }
      }
    })
    .use(ElementPlus)
    .mount('#app')
  </script>
</body>
</html>
