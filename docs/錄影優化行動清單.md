# 錄影流程穩定度優化行動清單

本清單彙整目前錄影流程與 BLE 掃描遇到的主要異常，提供**檔案修改建議**、**必要指令**與**驗收項目**，以利逐項落實與回歸測試。

## 一、檔案修改建議

### 1. `lib/pages/recording_session_page.dart`
- [ ] 於初始化流程中新增**相機資源鎖**，避免同時進行錄影與縮圖截圖導致 `ImageReader` 緩衝區耗盡。
- [ ] 在 `dispose()` 中確保依序停止錄影、恢復預覽再釋放控制器，避免 ANR。
- [ ] 將縮圖產生流程改為**非同步序列佇列**，每次僅允許一張照片處理，並於完成後即時回寫縮圖路徑。

### 2. `lib/recorder_page.dart`
- [ ] 在 BLE 掃描啟動前檢查 `AppOps` 權限與封包來源，若接獲 `uid` 不符錯誤應主動中止流程並提示使用者。
- [ ] 針對 `startScan/stopScan` 加上節流機制（建議使用 800ms debounce），避免頻繁切換觸發系統錯誤。

### 3. `android/app/src/main/kotlin/com/example/golf_score_app/MainActivity.kt`
- [ ] 為 `KeepScreenOnService` 補上生命周期紀錄與錯誤捕捉，確保螢幕常亮狀態與 Activity 對齊。
- [ ] 監聽 `onTrimMemory()` 與 `onStop()`，在進入背景時釋放相機與藍芽資源。

### 4. `lib/services/imu_data_logger.dart`
- [ ] CSV 寫入時增加檔案存在與磁碟空間檢查，失敗時回傳錯誤碼供 UI 顯示。

### 5. 測試與文件
- [ ] 於 `docs/` 補充「錄影與藍芽除錯指南」，記錄常見 log 與排查步驟。

## 二、建議指令流程

| 階段 | 指令 | 用途 |
| --- | --- | --- |
| 清除舊資源 | `flutter clean` | 移除舊快取與編譯產物。 |
| 依賴同步 | `flutter pub get` | 重新安裝依賴套件。 |
| 原生建置 | `flutter build apk --debug` | 確認 Kotlin/Gradle 設定無誤。 |
| 裝置偵錯 | `flutter run --verbose` | 觀察 BLE 與相機行為，蒐集 log。 |

## 三、驗收清單

1. **錄影流程**
   - [ ] 連續錄製 5 輪，確認預覽尺寸與最終影片一致。
   - [ ] 錄影結束後自動產生縮圖並於首頁顯示。
   - [ ] 錄影期間螢幕保持常亮，離開頁面恢復系統預設。

2. **藍芽掃描**
   - [ ] 啟動掃描 3 次皆無 `uid` 不符錯誤。
   - [ ] 可同時維持兩顆 IMU 連線並寫入 CSV。

3. **效能與穩定度**
   - [ ] 無 `ImageReader` 緩衝警告。
   - [ ] 無 ANR 或應用強制關閉紀錄。

4. **資料持久化**
   - [ ] 首頁與錄影歷史皆可讀取最新縮圖、影片與 CSV。
   - [ ] 調整影片名稱、長度後不再觸發 `_lifecycleState` 相關例外。

> 完成上述步驟後建議再次執行 `flutter build apk` 並於實機回歸，確認所有流程正常運行。
